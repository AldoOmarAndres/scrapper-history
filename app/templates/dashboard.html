<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolución de Tasas</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        #chart { width: 100%; height: 500px; }
        .btn-refresh { display: block; margin: 20px auto; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-refresh:hover { background: #0056b3; }
        .btn-refresh[disabled] { opacity: 0.7; cursor: not-allowed; }
        .stats-box { background: #f8f9fa; border: 2px solid #007bff; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .stats-box h2 { color: #007bff; margin-top: 0; font-size: 18px; }
        .stat-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 15px; }
        .stat-item { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #17BECF; }
        .stat-item h3 { margin: 0 0 8px 0; font-size: 14px; color: #666; font-weight: 600; text-transform: uppercase; }
        .stat-item .value { font-size: 24px; font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .stat-item .time { font-size: 12px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Evolución Tasa Tomadora</h1>
        <label for="plazo-filter">Filtrar por plazo:</label>
        <select id="plazo-filter" onchange="fetchData()"></select>
        
        <div class="stats-box">
            <h2>Estadísticas del Día - Período <span id="periodo-label"></span></h2>
            <div class="stat-row">
                <div class="stat-item">
                    <h3>1ª Tasa del Día</h3>
                    <div class="value" id="first-rate">-</div>
                    <div class="time" id="first-time">-</div>
                </div>
                <div class="stat-item">
                    <h3>Tasa Mayor</h3>
                    <div class="value" id="max-rate">-</div>
                    <div class="time" id="max-time">-</div>
                </div>
                <div class="stat-item">
                    <h3>Tasa Menor</h3>
                    <div class="value" id="min-rate">-</div>
                    <div class="time" id="min-time">-</div>
                </div>
            </div>
        </div>
        
        <div id="chart"></div>
        <button id="btn-refresh" class="btn-refresh" onclick="fetchData()">Actualizar Datos</button>
    </div>

    <script>
        let allData = [];

        function formatTimeFromDate(dateString) {
            return new Date(dateString).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }

        function updateStats(filteredData) {
            if (filteredData.length === 0) {
                document.getElementById('first-rate').textContent = '-';
                document.getElementById('first-time').textContent = '-';
                document.getElementById('max-rate').textContent = '-';
                document.getElementById('max-time').textContent = '-';
                document.getElementById('min-rate').textContent = '-';
                document.getElementById('min-time').textContent = '-';
                return;
            }

            // Ordenar por fecha para obtener la 1ª tasa del día
            const sortedByTime = [...filteredData].sort((a, b) => new Date(a.fecha_hora_web) - new Date(b.fecha_hora_web));
            const firstEntry = sortedByTime[0];

            // Encontrar máximo y mínimo
            const maxEntry = filteredData.reduce((max, item) => item.tasa_tomadora > max.tasa_tomadora ? item : max);
            const minEntry = filteredData.reduce((min, item) => item.tasa_tomadora < min.tasa_tomadora ? item : min);

            // Actualizar 1ª tasa del día
            document.getElementById('first-rate').textContent = firstEntry.tasa_tomadora.toFixed(2);
            document.getElementById('first-time').textContent = formatTimeFromDate(firstEntry.fecha_hora_web);

            // Actualizar máximo
            document.getElementById('max-rate').textContent = maxEntry.tasa_tomadora.toFixed(2);
            document.getElementById('max-time').textContent = formatTimeFromDate(maxEntry.fecha_hora_web);

            // Actualizar mínimo
            document.getElementById('min-rate').textContent = minEntry.tasa_tomadora.toFixed(2);
            document.getElementById('min-time').textContent = formatTimeFromDate(minEntry.fecha_hora_web);
        }

        async function fetchData() {
            const btn = document.getElementById('btn-refresh');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Cargando...';
            try {
                const response = await fetch('/today'); 
                const result = await response.json();

                if (result.status !== 'success') {
                    alert("Error obteniendo datos: " + result.message);
                    return;
                }

                allData = result.data;

                const plazoSeleccionado = updatePlazoFilter(allData);

                const select = document.getElementById('plazo-filter');
                let selectedPlazo = select.value;
                if (!selectedPlazo && plazoSeleccionado) {
                    selectedPlazo = plazoSeleccionado;
                    select.value = plazoSeleccionado;
                }

                let filteredData = allData.filter(item => item.plazo === selectedPlazo);

                // Ordenar por fecha asc 
                filteredData.sort((a, b) => new Date(a.fecha_hora_web) - new Date(b.fecha_hora_web));

                // Actualizar estadísticas
                updateStats(filteredData);
                document.getElementById('periodo-label').textContent = selectedPlazo;

                // Datos para Plotly
                const dates = filteredData.map(item => new Date(item.fecha_hora_web).toLocaleTimeString());
                const rates = filteredData.map(item => item.tasa_tomadora);
                const plazos = filteredData.map(item => item.plazo);

                // Configuración del grafico
                const trace = {
                    x: dates,
                    y: rates,
                    text: plazos,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Tasa Tomadora',
                    line: { shape: 'spline', color: '#17BECF' }
                };

                const layout = {
                    title: 'Histórico de Tasas',
                    xaxis: { title: 'Hora' },
                    yaxis: { title: 'Tasa (%)' }
                };

                Plotly.newPlot('chart', [trace], layout);

            } catch (error) {
                console.error('Error:', error);
                alert("Error de conexión con el backend.");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function updatePlazoFilter(data) {
            const select = document.getElementById('plazo-filter');
            const currentValue = select.value;
            select.innerHTML = '';
            const plazosUnicos = [...new Set(data.map(item => item.plazo))];
            
            plazosUnicos.sort((a, b) => parseInt(a) - parseInt(b));
            plazosUnicos.forEach((plazo, idx) => {
                const option = document.createElement('option');
                option.value = plazo;
                option.textContent = plazo;
                select.appendChild(option);
            });
            if (plazosUnicos.length > 0) {
                if (plazosUnicos.includes(currentValue)) {
                    select.value = currentValue;
                    return currentValue;
                } else {
                    select.value = plazosUnicos[0];
                    return plazosUnicos[0];
                }
            }
            return null;
        }

        fetchData();
        // Auto-refresh cada 2 minutos
        setInterval(fetchData, 2 * 60 * 1000);
    </script>
</body>
</html>